pipeline {
    agent any
    stages {
        stage('First Stage'){
          steps{
            echo 'First stage...'
                }
        }
		
		stage('Get Ansible Inventory from GIT'){
			steps{
				script{
					def hosts_link_file = "${JENKINS_HOME}/hosts_links.txt"
					if (fileExists(file: "${hosts_link_file}")) {
						def host_properties = readProperties file: "${hosts_link_file}"
						ANSIBLE_GIT_SOURCE = host_properties.ANSIBLE_INV_GIT_LINK
					}
					else {
						error ("File ${hosts_link_file} does not exist")
					}
				}

					checkout([
					$class: 'GitSCM',
					branches: [[name: '*/main']],
					extensions: [[$class: 'RelativeTargetDirectory', relativeTargetDir: 'ansible-inventory']],
					userRemoteConfigs: [[ credentialsId: 'my-github',
					url: "${ANSIBLE_GIT_SOURCE}"]]])
			}
		}

		stage('Start Maintenance'){
		    steps{
		        script{
		            def ANSIBLE_PLAYBOOK = "${WORKSPACE}/ansible/playbooks/start_maintenance.yaml"
		            def ANSIBLE_INVENTORY = "${WORKSPACE}/ansible-inventory/dev/inventory"
		        }
		        ansiblePlaybook(
		            playbook: "${ANSIBLE_PLAYBOOK}",
		            inventory: "${ANSIBLE_INVENTORY}"
		        )
		    }
		}

    }
}
